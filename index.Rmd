---
title:
html_notebook: default
---

## Inequalities in Emergency Hospital Admission in Aberdeen

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(janitor)
library(sf)
library(mapview)
library(gt)
library(cowplot)
library(plotly)
theme_set(theme_cowplot()) 
```

```{r, include=FALSE}
#load data and shapefile

simd_zones <- read_csv(here("data", "SIMD+2020v2+-+datazone+lookup.csv")) %>%
  clean_names() %>%
  rename(dz_name = d_zname)

simd_indicators <- read_csv(here("data", "SIMD2020v2_indicators.csv")) %>%
  clean_names()

datazone_sf <- st_read(here("data", "sc_dz_11.shp"), quiet = T)

simd <- 
  left_join(simd_indicators, simd_zones, by = c("data_zone" = "dz"))

rm(simd_indicators, simd_zones)
```

```{r, include=FALSE}
simd <-
  simd %>%
  mutate(
    across(simd2020v2_rank:population, ~ as.integer(.)),
    emerg = (emerg - 100)/100)

simd_aberdeen <-
  simd %>%
  filter(council_area == "Aberdeen City") %>%
  arrange(simd2020v2_rank) %>%
  mutate(aberdeen_rank = 
           row_number(),
         aberdeen_decile =
           as_factor(ntile(.$simd2020v2_rank, 10)),
         aberdeen_vigintile =
           as_factor(ntile(.$simd2020v2_rank, 20)),
         aberdeen_percentile =
           as_factor(ntile(.$simd2020v2_rank, 100)))
```
  
Aberdeen's emergency hospital admission rate is **`r median(simd_aberdeen$emerg)*100`% lower than Scotland's** (adjusted for the age and sex of the population).  

However, there are **large differences in emergency admissions across the city**. The emergency admissions rate ranges from `r simd_aberdeen %>% arrange(emerg) %>% slice_tail() %>% .$emerg*100`% higher than the Scottish average to `r simd_aberdeen %>% arrange(emerg) %>% slice_head() %>% .$emerg*-100`%
lower. 

```{r, include=FALSE}
#select Aberdeen City datazones
#join to make separate shapefile

aberdeen_data_zones <- pull(simd_aberdeen, data_zone)

aberdeen_sf <- filter(datazone_sf, DataZone %in% aberdeen_data_zones)

aberdeen_sf <-
  left_join(aberdeen_sf, simd_aberdeen, by = c("DataZone" = "data_zone"))
```
<br>

### Mapping Emergency Hospital Admissions
Heathryfold, Middlefied, Mastrick and Northfield have **much higher** emergency admission rates than expected. The Deeside areas have **much lower** emergency admission rates than expected.  
Hover or click to see area names
```{r, echo=FALSE}
aberdeen_sf %>%
  select(DataZone, Name, emerg, geometry) %>%
  mapview(
    map.types = "OpenStreetMap",
    zcol = "emerg", 
    label = aberdeen_sf$Name,
    layer.name = "Emergency Admit Rate<br>vs Scotland",
    alpha.regions = 0.75,
    na.label = ""
    )
```
  
  
```{r, include=FALSE}
vigintile_values <-
  simd_aberdeen %>%
  group_by(aberdeen_vigintile) %>%
  summarise(median = median(emerg))
```
<br>

### Deprived Areas Need More Emergency Care 
**Emergency admissions rise steeply as area deprivation rises.**  
Hover or click to see area names
```{r, echo=FALSE}
q <-
simd_aberdeen %>%
  ggplot(aes(aberdeen_rank, emerg, label = dz_name)) +
  geom_hline(yintercept = 0, color = "dark grey", size = 1, alpha = 0.5) +
  annotate("text", x = 10, y = -0.3, label = "Fewer emergencies\nthan expected", size = 3) +
  annotate("text", x = 250, y = 0.3, label = "More emergencies\nthan expected", size = 3) +
  geom_point(alpha = 0.5, colour = "dark red") +
  scale_x_reverse(breaks = c(1, 100, 200, 300), 
                  labels = c("1\nmost deprived", "100", "200", "300\nleast deprived"), expand = c(0, 30)) +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "NA",
        plot.margin = margin(1,1,1,1, unit = "cm")) +
  labs(x = "Deprivation Rank", 
       y = "Emergency Hosptial Admissions\n(difference from Scottish Average)") +
  theme(axis.text = element_text(size = 8),
        axis.title = element_text(size = 12))

ggplotly(q, tooltip = "label") %>%
  layout(margin = list(
    r = 10,
    l = 1,
    t = 20,
    b = 1
  ))
```
<br>

### Data for all Aberdeen Areas
```{r, echo=FALSE}
simd_aberdeen %>%
  select(data_zone, dz_name, emerg, simd2020v2_decile) %>%
  arrange(desc(emerg)) %>%
  gt() %>%
  tab_header(
    title = "Emergency hospital admissions relative to Scottish average (age-sex adjusted)", 
    subtitle = "All Aberdeen data zones, sorted by highest emergency admissions") %>%
  cols_label(
    data_zone = "Data Zone",
    dz_name = "Name",
    emerg = "Emergency Admissions",
    simd2020v2_decile = "SIMD decile (lower is more deprived)")  %>%
    fmt_percent(emerg, decimals = 0) %>%
  tab_options(container.height = 400,
              data_row.padding = 1)
```
<br>

### Methods
This analysis uses emergency admissions to non-psychiatric and non-obstetric NHS hospitals for the four-year period of 2014 to 2017. Data are given for the 283 Scottish Government Data Zones in Aberdeen city. Admission rates are indirectly age and sex standardised and given relative to the expected value for Scotland.

Data source: Scottish Government Index of Multiple Deprivation (data_zone and emerg variables) (<https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/>)

Methodology: <https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/09/simd-2020-technical-notes/documents/simd-2020-technical-notes/simd-2020-technical-notes/govscot%3Adocument/SIMD%2B2020%2Btechnical%2Bnotes.pdf?forceDownload=true>  

Analysis code: <https://github.com/JessButler/emergency_admissions>

Author: Jess Butler [jessicabutler\@abdn.ac.uk](mailto:jessicabutler@abdn.ac.uk){.email}